# Seafile GC

Seafile 利用存储去重技术来减少存储资源的利用。
简单来说，这包含如下两层含义：

* 不同版本的文件或许会共享一些数据块。
* 不同的资料库也或许会共享一些数据块。

运用这项技术之后，在你删除一个资料库时，会导致底层数据块不会被立即删除，因此 Seafile 服务器端没用的数据块将会增多。

通过运行**垃圾回收**程序，可以清理无用的数据块，释放无用数据块所占用的存储空间。

垃圾回收程序将会清理如下两种无用数据块：

1. 未被资料库所引用的数据块。
2. 设置了历史长度限制的资料库的过期数据块。

**运行垃圾回收程序之前，请先在服务器端停掉 Seafile 程序。**

这是因为垃圾回收程序，会错误的删除刚刚写入 Seafile 的新的数据块。

## 3.1.2 及之后版本

运行垃圾回收程序

    ./seaf-gc.sh run

程序结束之后，运行以下命令，检查是否误删了还在使用的数据块，如果误删，会显示警告信息。

    ./seaf-gc.sh verify

可以通过 `dry-run` 选项，设置在运行垃圾回收程序前，进行完整性检查

程序将会显示 *所有的数据块数量* 和 *将要被删除的数据块数量*

    ./seaf-gc.sh dry-run

如果资料库已损坏，因为无法判断数据块是否还在被其他资料库使用，所以垃圾回收程序将会停止运行。

可以通过 `force` 选项，强制删除已损坏资料库的数据。通过将已损坏资料库的数据块标记为“未使用”，来将其删除。

    ./seaf-gc.sh force

## 3.1.2 及之前版本

运行垃圾回收程序

    cd seafile-server-{version}/seafile
    export LD_LIBRARY_PATH=./lib:${LD_LIBRARY_PATH}
    ./bin/seafserv-gc -c ../../ccnet -d ../../seafile-data

如果你[源码编译安装 Seafile 服务器](../build_seafile/linux.md)，仅仅运行

    seafserv-gc -c ../../ccnet -d ../../seafile-data

当垃圾回收程序结束后，你也可以检查是否一些有用的数据块被错误的删除：

    seafserv-gc -c ../../ccnet -d ../../seafile-data --verify

如果一些有用的数据块丢失，它将会打印一些警告信息。

如果你想在真正删除一些数据块之前，做一些常规检查，可以使用--dry-run选项

    seafserv-gc -c ../../ccnet -d ../../seafile-data --dry-run

这将会向你展示数据块总数量和将被删除数据块数量。

如果在服务器端一些库的元数据被毁坏，垃圾回收程序将会停止处理，因为它无法识别是否一个数据块被一些毁坏的资料库所使用。如果你不想保留毁坏库的数据块，可以运行垃圾回收程序并使用--ignore-errors或-i选项。

    seafserv-gc -c ../../ccnet -d ../../seafile-data --ignore-errors

这将会屏蔽毁坏资料库的数据块为无用状态并删除掉它们。
